(()=>{"use strict";const e={DD:e=>t(e.getDate(),2),D:e=>e.getDate()+"",MM:e=>t(e.getMonth()+1,2),M:e=>e.getMonth()+1+"",YYYY:e=>t(e.getFullYear(),4),YY:e=>(e.getFullYear()+"").substr(-2,2),HH:e=>t(e.getHours(),2),H:e=>e.getHours()+"",mm:e=>t(e.getMinutes(),2),m:e=>e.getMinutes()+"",ss:e=>t(e.getSeconds(),2),s:e=>e.getSeconds()+"",u:e=>t(e.getMilliseconds(),3)};function t(e,t){let i=e+"";for(;i.length<t;)i="0"+i;return i}const i=(()=>{const t=Object.keys(e).concat("\\[[^\\[\\]]*\\]");return new RegExp(t.join("|"),"g")})();function o(t,o){return o.replace(i,(i=>e.hasOwnProperty(i)?e[i](t):i.replace(/\[|\]/g,"")))}const s=self;let r=new Map;s.onmessage=e=>{const t=e.data,{requestType:i,id:n}=t,d=function(e,t){var i={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(i[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(o=Object.getOwnPropertySymbols(e);s<o.length;s++)t.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(e,o[s])&&(i[o[s]]=e[o[s]])}return i}(t,["requestType","id"]);if("webcodecs"===i){let e=r.get(n);e||(e=new class extends class{constructor(e){this.id=e,this.prefix="",this.prefix=`[${e}]${this.prefix?" ["+this.prefix+"]":""}`}_log(...e){console.log(`[${o(new Date,"YYYY-MM-DD HH:mm:ss.u")}]${this.prefix} [INFO]`,...e)}_warn(...e){console.warn(`[${o(new Date,"YYYY-MM-DD HH:mm:ss.u")}]${this.prefix} [WARN]`,...e)}_error(...e){console.error(`[${o(new Date,"YYYY-MM-DD HH:mm:ss.u")}]${this.prefix} [ERROR]`,...e)}_debug(...e){console.log(`[${o(new Date,"YYYY-MM-DD HH:mm:ss.u")}]${this.prefix} [DEBUG]`,...e)}}{constructor(e,t){super(e),this.id=e,this.worker=t,this.name="webcodec-worker",this._priv_vFirstKey=!1,this._priv_aFirstKey=!1,this.worker=t}postMessage(e){const{init:t,addChunk:i}=e;if(t){const{type:e,initConfig:i}=t,o=e=>{};if(this._log(`decoder init..., type is ${e}`),"video"===e){const e=e=>{this._postMessage("video_frame",e,[e])};this._initVideo({initConfig:i,frameCallBack:e,errCallBack:o})}else{const e=e=>{const t=e.allocationSize({planeIndex:0,format:e.format});let i=new Float32Array(t);e.copyTo(i,{planeIndex:0,format:e.format}),this._postMessage("audio_frame",{pts:+(e.timestamp/1e3/1e3).toFixed(3),sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,data:[i],size:e.numberOfFrames},[i.buffer]),e.close()};this._initAudio({initConfig:i,frameCallBack:e,errCallBack:o})}}if(i){const{type:e,data:t}=i;"video"===e?this._addVideoChunk(t):this._addAudioChunk(t),this._debug("add chunk")}}destroy(){var e,t;null===(e=this.videoDecoder)||void 0===e||e.close(),null===(t=this.audioDecoder)||void 0===t||t.close(),this._log(`remove webcodecs ${this.id} success!`)}_initVideo(e){const{initConfig:t,frameCallBack:i,errCallBack:o}=e,s={output:i.bind(this),error:o};this.videoDecoder=new VideoDecoder(s),VideoDecoder.isConfigSupported(t).then((e=>{var i;e.supported?(this._log(`video config is supported, params is ${JSON.stringify(e.config)}`),null===(i=this.videoDecoder)||void 0===i||i.configure(t)):this._error("VIDEO CONFIG NOT SUPPORT",`video config is not supported, params is ${JSON.stringify(e.config)}`)}))}_initAudio(e){const{initConfig:t,frameCallBack:i,errCallBack:o}=e,s={output:i.bind(this),error:o};this.audioDecoder=new AudioDecoder(s),AudioDecoder.isConfigSupported(t).then((e=>{var i;e.supported?(this._log(`audio config is supported, params is ${JSON.stringify(e.config)}`),null===(i=this.audioDecoder)||void 0===i||i.configure(t)):this._error("AUDIO CONFIG NOT SUPPORT","audio config is not supported ")}))}_addAudioChunk(e){if(!this._priv_aFirstKey){if("key"!==e.type)return;this._priv_aFirstKey=!0}if(this.audioDecoder){const t=new EncodedAudioChunk(e);this.audioDecoder.decode(t)}else this._debug("Audio Decoder is not created!")}_addVideoChunk(e){if(!this._priv_vFirstKey){if("key"!==e.type)return;this._priv_vFirstKey=!0}if(this.videoDecoder){const t=new EncodedVideoChunk(e);this.videoDecoder.decode(t)}else this._debug("Video Decoder is not created!")}_postMessage(e,t,i=[],o=0){this.worker.postMessage({id:this.id,error:o,type:e,data:t},i)}}(n,s),r.set(n,e)),e.postMessage(d)}}})();